using System.Text;

namespace FakeMicro.Utilities.CodeGenerator.Templates
{
    /// <summary>
    /// Grain实现模板 - 改进版本
    /// </summary>
    public static class GrainTemplate_Fixed
    {
        public static string Generate(EntityMetadata entity)
        {
            var sb = new StringBuilder();
            
            // 文件头注释
            sb.AppendLine($"// <auto-generated>");
            sb.AppendLine($"//     此代码由代码生成器生成，请勿手动修改");
            sb.AppendLine($"//     生成时间: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
            sb.AppendLine($"// </auto-generated>");
            sb.AppendLine();
            
            // Using语句
            sb.AppendLine("using System.Threading;");
            sb.AppendLine("using System.Threading.Tasks;");
            sb.AppendLine("using System.Collections.Generic;");
            sb.AppendLine("using System.Linq;");
            sb.AppendLine("using Microsoft.Extensions.Logging;");
            sb.AppendLine("using Orleans;");
            sb.AppendLine("using Orleans.Runtime;");
            sb.AppendLine("using System;");
            sb.AppendLine($"using {entity.Namespace}.Interfaces;");
            sb.AppendLine($"using {entity.Namespace}.Models;");
            sb.AppendLine($"using {entity.Namespace}.Models.Requests;");
            sb.AppendLine($"using {entity.Namespace}.Models.Results;");
            sb.AppendLine($"using {entity.Namespace}.Repository;");
            sb.AppendLine("using FakeMicro.DatabaseAccess;");
            sb.AppendLine();
            
            // 命名空间
            sb.AppendLine($"namespace {entity.Namespace}.Grains");
            sb.AppendLine("{");
            
            // 类定义
            sb.AppendLine("    /// <summary>");
            sb.AppendLine($"    /// {entity.EntityDescription}Grain实现 - 改进版本");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine($"    public class {entity.EntityName}Grain :Grain,I{entity.EntityName}Grain");
            sb.AppendLine("    {");
            
            // 字段和构造函数 - 使用依赖注入
            sb.AppendLine($"        private readonly ILogger<{entity.EntityName}Grain> _logger;");
            sb.AppendLine($"        private readonly IMapper _mapper;");
            sb.AppendLine($"        private readonly I{entity.EntityName}Repository _repository;");
            sb.AppendLine();
            sb.AppendLine($"        public {entity.EntityName}Grain(");
            sb.AppendLine($"            ILogger<{entity.EntityName}Grain> logger,");
            sb.AppendLine($"            IMapper mapper,");
            sb.AppendLine($"            I{entity.EntityName}Repository repository)"); // 通过接口注入
            sb.AppendLine("        {");
            sb.AppendLine($"            _logger = logger;");
            sb.AppendLine($"            _mapper = mapper;");
            sb.AppendLine($"            _repository = repository;");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 获取方法 - 改进错误处理
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 获取{entity.EntityDescription}");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public async Task<{entity.EntityName}Dto?> GetAsync(CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                if (!this.GetPrimaryKey(out Guid grainId))");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogWarning(\"无效的Grain ID: {{GrainId}}\", this.GetPrimaryKeyString());");
            sb.AppendLine("                    return null;");
            sb.AppendLine("                }");
            sb.AppendLine();
            sb.AppendLine($"                var entity = await _repository.GetByIdAsync(grainId, cancellationToken);"); // 使用注入的仓储
            sb.AppendLine("                if (entity == null)");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogInformation(\"{entity.EntityDescription}不存在: {{Id}}\", grainId);");
            sb.AppendLine("                    return null;");
            sb.AppendLine("                }");
            sb.AppendLine($"                return _mapper.Map<{entity.EntityName}Dto>(entity);");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogError(ex, \"获取{entity.EntityDescription}时发生错误: {{Id}}\", this.GetPrimaryKeyString());");
            sb.AppendLine("                throw; // 对于查询操作，抛出异常更合适");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 创建方法 - 改进错误处理和异常管理
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 创建{entity.EntityDescription}");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public async Task<Create{entity.EntityName}Result> CreateAsync(Create{entity.EntityName}Request request, CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                if (!this.GetPrimaryKey(out Guid grainId))");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogWarning(\"无效的Grain ID: {{GrainId}}\", this.GetPrimaryKeyString());");
            sb.AppendLine($"                    return Create{entity.EntityName}Result.InvalidGrainId();");
            sb.AppendLine("                }");
            sb.AppendLine();
            sb.AppendLine($"                var entity = _mapper.Map<{entity.EntityName}>(request);");
            sb.AppendLine();
            sb.AppendLine("                // 设置默认值");
            sb.AppendLine("                entity.Id = grainId;");
            sb.AppendLine("                entity.CreatedAt = DateTime.UtcNow;");
            sb.AppendLine("                entity.UpdatedAt = DateTime.UtcNow;");
            
            if (entity.IsSoftDeletable)
            {
                sb.AppendLine("                entity.IsDeleted = false;");
            }
            
            sb.AppendLine();
            sb.AppendLine($"                var createdEntity = await _repository.InsertAsync(entity, cancellationToken);"); // 使用注入的仓储
            sb.AppendLine($"                var result = _mapper.Map<{entity.EntityName}Dto>(createdEntity);");
            sb.AppendLine();
            sb.AppendLine($"                _logger.LogInformation(\"{entity.EntityDescription}创建成功: {{Id}}\", createdEntity.Id);");
            sb.AppendLine($"                return Create{entity.EntityName}Result.Success(result);");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (SqlSugarException ex) when (ex.Number == 2627) // 唯一键冲突");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogWarning(ex, \"创建{entity.EntityDescription}时发生唯一键冲突\");");
            sb.AppendLine($"                return Create{entity.EntityName}Result.Conflict(\"该{entity.EntityDescription}已存在\");");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (DbUpdateException ex) when (ex.InnerException?.Message.Contains(\"FK_\") == true)");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogWarning(ex, \"创建{entity.EntityDescription}时发生外键约束错误\");");
            sb.AppendLine($"                return Create{entity.EntityName}Result.InvalidReference(\"引用的数据不存在\");");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogError(ex, \"创建{entity.EntityDescription}时发生系统错误\");");
            sb.AppendLine($"                return Create{entity.EntityName}Result.Failure(\"创建失败，请稍后重试\");");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 更新方法 - 使用注入的仓储
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 更新{entity.EntityDescription}");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public async Task<Update{entity.EntityName}Result> UpdateAsync(Update{entity.EntityName}Request request, CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                if (!this.GetPrimaryKey(out Guid grainId))");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogWarning(\"无效的Grain ID: {{GrainId}}\", this.GetPrimaryKeyString());");
            sb.AppendLine($"                    return Update{entity.EntityName}Result.InvalidGrainId();");
            sb.AppendLine("                }");
            sb.AppendLine();
            sb.AppendLine($"                var existingEntity = await _repository.GetByIdAsync(grainId, cancellationToken);");
            sb.AppendLine("                if (existingEntity == null)");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogInformation(\"{entity.EntityDescription}不存在: {{Id}}\", grainId);");
            sb.AppendLine($"                    return Update{entity.EntityName}Result.NotFound(\"{entity.EntityDescription}不存在\");");
            sb.AppendLine("                }");
            sb.AppendLine();
            sb.AppendLine("                // 更新字段");
            sb.AppendLine("                _mapper.Map(request, existingEntity);");
            sb.AppendLine("                existingEntity.UpdatedAt = DateTime.UtcNow;");
            sb.AppendLine();
            sb.AppendLine($"                await _repository.UpdateAsync(existingEntity, cancellationToken);");
            sb.AppendLine($"                var result = _mapper.Map<{entity.EntityName}Dto>(existingEntity);");
            sb.AppendLine();
            sb.AppendLine($"                _logger.LogInformation(\"{entity.EntityDescription}更新成功: {{Id}}\", existingEntity.Id);");
            sb.AppendLine($"                return Update{entity.EntityName}Result.Success(result);");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogError(ex, \"更新{entity.EntityDescription}时发生错误: {{Id}}\", this.GetPrimaryKeyString());");
            sb.AppendLine($"                return Update{entity.EntityName}Result.Failure(\"更新失败，请稍后重试\");");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 删除方法 - 统一的软删除逻辑
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 删除{entity.EntityDescription}");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public async Task<Delete{entity.EntityName}Result> DeleteAsync(CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                if (!this.GetPrimaryKey(out Guid grainId))");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogWarning(\"无效的Grain ID: {{GrainId}}\", this.GetPrimaryKeyString());");
            sb.AppendLine($"                    return Delete{entity.EntityName}Result.InvalidGrainId();");
            sb.AppendLine("                }");
            sb.AppendLine();
            sb.AppendLine($"                var existingEntity = await _repository.GetByIdAsync(grainId, cancellationToken);");
            sb.AppendLine("                if (existingEntity == null)");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogInformation(\"{entity.EntityDescription}不存在: {{Id}}\", grainId);");
            sb.AppendLine($"                    return Delete{entity.EntityName}Result.NotFound(\"{entity.EntityDescription}不存在\");");
            sb.AppendLine("                }");
            sb.AppendLine();
            
            if (entity.IsSoftDeletable)
            {
                sb.AppendLine("                // 软删除");
                sb.AppendLine("                existingEntity.IsDeleted = true;");
                sb.AppendLine("                existingEntity.UpdatedAt = DateTime.UtcNow;");
                sb.AppendLine($"                await _repository.UpdateAsync(existingEntity, cancellationToken);");
            }
            else
            {
                sb.AppendLine($"                await _repository.DeleteAsync(grainId, cancellationToken);");
            }
            
            sb.AppendLine();
            sb.AppendLine($"                _logger.LogInformation(\"{entity.EntityDescription}删除成功: {{Id}}\", grainId);");
            sb.AppendLine($"                return Delete{entity.EntityName}Result.Success();");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogError(ex, \"删除{entity.EntityDescription}时发生错误: {{Id}}\", this.GetPrimaryKeyString());");
            sb.AppendLine($"                return Delete{entity.EntityName}Result.Failure(\"删除失败，请稍后重试\");");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 获取列表方法 - 使用仓储
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 获取{entity.EntityDescription}列表");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public async Task<List<{entity.EntityName}Dto>> GetListAsync(int page = 1, int pageSize = 20, CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            
            if (entity.IsSoftDeletable)
            {
                sb.AppendLine($"                var entities = await _repository.GetListAsync(x => !x.IsDeleted, page, pageSize, cancellationToken);");
            }
            else
            {
                sb.AppendLine($"                var entities = await _repository.GetListAsync(page, pageSize, cancellationToken);");
            }
            
            sb.AppendLine();
            sb.AppendLine($"                return _mapper.Map<List<{entity.EntityName}Dto>>(entities);");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogError(ex, \"获取{entity.EntityDescription}列表时发生错误\");");
            sb.AppendLine("                throw;");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 获取总数方法 - 使用仓储
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 获取{entity.EntityDescription}总数");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public async Task<int> GetCountAsync(CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            
            if (entity.IsSoftDeletable)
            {
                sb.AppendLine($"                return await _repository.CountAsync(x => !x.IsDeleted, cancellationToken);");
            }
            else
            {
                sb.AppendLine($"                return await _repository.CountAsync(cancellationToken);");
            }
            
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogError(ex, \"获取{entity.EntityDescription}总数时发生错误\");");
            sb.AppendLine("                throw;");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 搜索方法 - 使用仓储
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 搜索{entity.EntityDescription}");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public async Task<List<{entity.EntityName}Dto>> SearchAsync(string keyword, int page = 1, int pageSize = 20, CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            
            if (entity.IsSoftDeletable)
            {
                sb.AppendLine($"                var entities = await _repository.SearchAsync(keyword, x => !x.IsDeleted, page, pageSize, cancellationToken);");
            }
            else
            {
                sb.AppendLine($"                var entities = await _repository.SearchAsync(keyword, page, pageSize, cancellationToken);");
            }
            
            sb.AppendLine();
            sb.AppendLine($"                return _mapper.Map<List<{entity.EntityName}Dto>>(entities);");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogError(ex, \"搜索{entity.EntityDescription}时发生错误\");");
            sb.AppendLine("                throw;");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            sb.AppendLine("    }");
            sb.AppendLine("}");
            
            return sb.ToString();
        }
    }
}