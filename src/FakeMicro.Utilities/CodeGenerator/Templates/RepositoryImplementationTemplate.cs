using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using SqlSugar;
using FakeMicro.Utilities.CodeGenerator.Entities;
using FakeMicro.Utilities.CodeGenerator;

namespace FakeMicro.Utilities.CodeGenerator.Templates
{
    /// <summary>
    /// 仓储实现模板
    /// 生成符合Orleans最佳实践的仓储实现类
    /// 继承SqlSugarRepository并实现相应的仓储接口
    /// </summary>
    public static class RepositoryImplementationTemplate
    {
        /// <summary>
        /// 生成仓储实现代码（使用EntityMetadata）
        /// </summary>
        /// <param name="entity">实体元数据</param>
        /// <returns>生成的代码字符串</returns>
        public static string Generate(EntityMetadata entity)
        {
            var sb = new StringBuilder();
            
            // 文件头注释
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("//     此代码由代码生成器生成，请勿手动修改");
            sb.AppendLine("//     生成时间: " + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
            sb.AppendLine("//     功能: " + entity.EntityDescription + "仓储实现类");
            sb.AppendLine("//     架构: 遵循Orleans最佳实践，继承SqlSugarRepository");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            
            // Using语句
            sb.AppendLine("using System;");
            sb.AppendLine("using System.Collections.Generic;");
            sb.AppendLine("using System.Linq;");
            sb.AppendLine("using System.Linq.Expressions;");
            sb.AppendLine("using System.Threading;");
            sb.AppendLine("using System.Threading.Tasks;");
            sb.AppendLine("using Microsoft.Extensions.Logging;");
            sb.AppendLine("using SqlSugar;");
            sb.AppendLine("using FakeMicro.DatabaseAccess;");
            sb.AppendLine("using FakeMicro.DatabaseAccess.Interfaces;");
            
            // 使用ProjectStructureMapping获取实体命名空间
            var entityNamespace = ProjectStructureMapping.GetNamespace(GenerationType.Entity, entity.EntityName);
            sb.AppendLine($"using {entityNamespace};");
            sb.AppendLine();
            
            // 命名空间 - 使用ProjectStructureMapping获取正确的命名空间
            var repositoryNamespace = ProjectStructureMapping.GetNamespace(GenerationType.RepositoryImplementation, entity.EntityName);
            sb.AppendLine($"namespace {repositoryNamespace}");
            sb.AppendLine("{");
            
            // 仓储实现类定义
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// " + entity.EntityDescription + "仓储实现类");
            sb.AppendLine("    /// 继承SqlSugarRepository，遵循Orleans架构最佳实践");
            sb.AppendLine("    /// </summary>");
            
            // 根据主键类型选择泛型参数
            var primaryKeyType = entity.PrimaryKeyType.ToLower() switch
            {
                "guid" => "Guid",
                "long" => "long", 
                "int" => "int",
                "string" => "string",
                _ => "Guid"
            };
            
            // 正确的继承声明：继承SqlSugarRepository并实现接口
            sb.AppendLine("    public class " + entity.EntityName + "Repository : SqlSugarRepository<" + entity.EntityName + ", " + primaryKeyType + ">, I" + entity.EntityName + "Repository");
            sb.AppendLine("    {");
            
            // 私有字段
            sb.AppendLine("        private readonly ILogger<" + entity.EntityName + "Repository> _logger;");
            sb.AppendLine();
            
            // 构造函数 - 正确的依赖注入
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// " + entity.EntityDescription + "仓储构造函数");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        /// <param name=\"db\">SqlSugar数据库客户端</param>");
            sb.AppendLine("        /// <param name=\"logger\">日志记录器</param>");
            sb.AppendLine("        public " + entity.EntityName + "Repository(ISqlSugarClient db, ILogger<" + entity.EntityName + "Repository> logger)");
            sb.AppendLine("            : base(db, logger)");
            sb.AppendLine("        {");
            sb.AppendLine("            _logger = logger ?? throw new ArgumentNullException(nameof(logger));");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 重写基类的GetByIdAsync方法以提供更好的性能
            sb.AppendLine("        #region 基类方法重写");
            sb.AppendLine();
            
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// 重写获取" + entity.EntityDescription + "方法，添加性能优化");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        /// <param name=\"id\">主键值</param>");
            sb.AppendLine("        /// <param name=\"cancellationToken\">取消令牌</param>");
            sb.AppendLine("        /// <returns>" + entity.EntityDescription + "实体</returns>");
            sb.AppendLine("        public new async virtual Task<" + entity.EntityName + "?> GetByIdAsync(" + primaryKeyType + " id, CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            cancellationToken.ThrowIfCancellationRequested();");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine("                // 使用SqlSugar的查询优化，添加WITH(NOLOCK)提示");
            sb.AppendLine("                return await GetSqlSugarClient().Queryable<" + entity.EntityName + ">()");
            sb.AppendLine("                    .With(SqlWith.NoLock)");
            sb.AppendLine("                    .Where(entity => entity." + entity.PrimaryKeyProperty + " == id)");
            sb.AppendLine("                    .FirstAsync(cancellationToken);");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (SqlSugarException ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _logger.LogError(ex, \"获取" + entity.EntityDescription + "失败: {Id}\", id);");
            sb.AppendLine("                throw new DataAccessException(\"获取" + entity.EntityDescription + "失败: \" + id, ex);");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // CreateAndReturnAsync方法 - 创建实体并返回
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// 创建" + entity.EntityDescription + "并返回创建后的实体");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        /// <param name=\"entity\">" + entity.EntityDescription + "实体</param>");
            sb.AppendLine("        /// <param name=\"cancellationToken\">取消令牌</param>");
            sb.AppendLine("        /// <returns>创建后的" + entity.EntityDescription + "实体</returns>");
            sb.AppendLine("        public async virtual Task<" + entity.EntityName + "> CreateAndReturnAsync(" + entity.EntityName + " entity, CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            cancellationToken.ThrowIfCancellationRequested();");
            sb.AppendLine("            if (entity == null) throw new ArgumentNullException(nameof(entity));");
            sb.AppendLine("            ");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine("                var result = await GetSqlSugarClient().Insertable(entity).ExecuteReturnEntityAsync(cancellationToken);");
            sb.AppendLine("                _logger.LogInformation(\"成功创建" + entity.EntityName + ": {Id}\", typeof(" + entity.EntityName + ").Name, entity." + entity.PrimaryKeyProperty + ");");
            sb.AppendLine("                return result;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (SqlSugarException ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _logger.LogError(ex, \"创建" + entity.EntityDescription + "失败\");");
            sb.AppendLine("                throw new DataAccessException(\"创建" + entity.EntityDescription + "失败\", ex);");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 软删除方法（如果实体支持软删除）
            if (entity.IsSoftDeletable)
            {
                sb.AppendLine("        /// <summary>");
                sb.AppendLine("        /// 软删除" + entity.EntityDescription);
                sb.AppendLine("        /// </summary>");
                sb.AppendLine("        /// <param name=\"id\">主键值</param>");
                sb.AppendLine("        /// <param name=\"cancellationToken\">取消令牌</param>");
                sb.AppendLine("        /// <returns>是否删除成功</returns>");
                sb.AppendLine("        public async virtual Task<bool> SoftDeleteAsync(" + primaryKeyType + " id, CancellationToken cancellationToken = default)");
                sb.AppendLine("        {");
                sb.AppendLine("            cancellationToken.ThrowIfCancellationRequested();");
                sb.AppendLine("            try");
                sb.AppendLine("            {");
                sb.AppendLine("                var result = await GetSqlSugarClient().Updateable<" + entity.EntityName + ">()");
                sb.AppendLine("                    .SetColumns(entity => new " + entity.EntityName + " { IsDeleted = true, DeleteTime = DateTime.UtcNow })");
                sb.AppendLine("                    .Where(entity => entity." + entity.PrimaryKeyProperty + " == id)");
                sb.AppendLine("                    .ExecuteCommandAsync(cancellationToken);");
                sb.AppendLine("                ");
                sb.AppendLine("                if (result > 0)");
                sb.AppendLine("                {");
                sb.AppendLine("                    _logger.LogInformation(\"成功软删除" + entity.EntityDescription + ": {Id}\", id);");
                sb.AppendLine("                    return true;");
                sb.AppendLine("                }");
                sb.AppendLine("                ");
                sb.AppendLine("                return false;");
                sb.AppendLine("            }");
                sb.AppendLine("            catch (SqlSugarException ex)");
                sb.AppendLine("            {");
                sb.AppendLine("                _logger.LogError(ex, \"软删除" + entity.EntityDescription + "失败: {Id}\", id);");
                sb.AppendLine("                throw new DataAccessException(\"软删除" + entity.EntityDescription + "失败: \" + id, ex);");
                sb.AppendLine("            }");
                sb.AppendLine("        }");
                sb.AppendLine();
            }
            
            sb.AppendLine("        #endregion");
            sb.AppendLine();
            
            // Orleans特定的仓储方法（基于Grain ID的操作）
            sb.AppendLine("        #region Orleans Grain特定操作");
            sb.AppendLine();
            
            // GetAsync - 通过Grain ID获取（无参数，使用Grain的ID作为主键）
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// 通过Grain ID获取" + entity.EntityDescription + "（Orleans特定）");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        /// <param name=\"cancellationToken\">取消令牌</param>");
            sb.AppendLine("        /// <returns>" + entity.EntityDescription + "实体</returns>");
            sb.AppendLine("        public async virtual Task<" + entity.EntityName + "?> GetByGrainIdAsync(CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            // 注意：此方法需要在Grain上下文中调用，通过Grain的ID获取实体");
            sb.AppendLine("            // 具体实现取决于Grain的ID策略");
            sb.AppendLine("            throw new NotImplementedException(\"需要在Grain上下文中实现GetByGrainIdAsync方法\");");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // CreateAsync - Orleans特定的创建方法
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// 创建" + entity.EntityDescription + "（Orleans特定）");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        /// <param name=\"entity\">" + entity.EntityDescription + "实体</param>");
            sb.AppendLine("        /// <param name=\"cancellationToken\">取消令牌</param>");
            sb.AppendLine("        /// <returns>创建后的" + entity.EntityDescription + "实体</returns>");
            sb.AppendLine("        public async virtual Task<" + entity.EntityName + "> CreateAsync(" + entity.EntityName + " entity, CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            return await CreateAndReturnAsync(entity, cancellationToken);");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            sb.AppendLine("        #endregion");
            sb.AppendLine();
            
            // 业务查询方法
            sb.AppendLine("        #region 业务查询方法");
            sb.AppendLine();
            
            // 基于属性的查询方法
            foreach (var prop in entity.Properties.Where(p => !p.IsPrimaryKey && !p.IsNavigationProperty))
            {
                if (prop.Type.ToLower().Contains("string"))
                {
                    sb.AppendLine("        /// <summary>");
                    sb.AppendLine("        /// 根据" + prop.Name + "查询" + entity.EntityDescription);
                    sb.AppendLine("        /// </summary>");
                    sb.AppendLine("        /// <param name=\"" + prop.Name.ToLower() + "\">" + prop.Name + "</param>");
                    sb.AppendLine("        /// <param name=\"cancellationToken\">取消令牌</param>");
                    sb.AppendLine("        /// <returns>" + entity.EntityDescription + "实体列表</returns>");
                    sb.AppendLine("        public async virtual Task<List<" + entity.EntityName + ">> GetBy" + prop.Name + "Async(string " + prop.Name.ToLower() + ", CancellationToken cancellationToken = default)");
                    sb.AppendLine("        {");
                    sb.AppendLine("            cancellationToken.ThrowIfCancellationRequested();");
                    sb.AppendLine("            if (string.IsNullOrEmpty(" + prop.Name.ToLower() + ")) throw new ArgumentException(\"Value cannot be null or empty\", nameof(" + prop.Name.ToLower() + "));");
                    sb.AppendLine("            try");
                    sb.AppendLine("            {");
                    sb.AppendLine("                return await GetSqlSugarClient().Queryable<" + entity.EntityName + ">()");
                    sb.AppendLine("                    .With(SqlWith.NoLock)");
                    sb.AppendLine("                    .Where(entity => entity." + prop.Name + " == " + prop.Name.ToLower() + ")");
                    sb.AppendLine("                    .ToListAsync(cancellationToken);");
                    sb.AppendLine("            }");
                    sb.AppendLine("            catch (SqlSugarException ex)");
                    sb.AppendLine("            {");
                    sb.AppendLine("                _logger.LogError(ex, \"根据" + prop.Name + "查询" + entity.EntityDescription + "失败: {" + prop.Name.ToLower() + "}\", " + prop.Name.ToLower() + ");");
                    sb.AppendLine("                throw new DataAccessException(\"根据" + prop.Name + "查询" + entity.EntityDescription + "失败: \" + " + prop.Name.ToLower() + ", ex);");
                    sb.AppendLine("            }");
                    sb.AppendLine("        }");
                    sb.AppendLine();
                }
            }
            
            // 分页查询方法
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// 分页查询" + entity.EntityDescription);
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        /// <param name=\"pageNumber\">页码</param>");
            sb.AppendLine("        /// <param name=\"pageSize\">页大小</param>");
            sb.AppendLine("        /// <param name=\"orderBy\">排序表达式</param>");
            sb.AppendLine("        /// <param name=\"isDescending\">是否降序</param>");
            sb.AppendLine("        /// <param name=\"cancellationToken\">取消令牌</param>");
            sb.AppendLine("        /// <returns>分页结果</returns>");
            sb.AppendLine("        public async virtual Task<PaginatedResult<" + entity.EntityName + ">> GetPagedAsync(int pageNumber, int pageSize, ");
            sb.AppendLine("            Expression<Func<" + entity.EntityName + ", object>>? orderBy = null, bool isDescending = false, CancellationToken cancellationToken = default)");
            sb.AppendLine("        {");
            sb.AppendLine("            cancellationToken.ThrowIfCancellationRequested();");
            sb.AppendLine("            if (pageNumber < 1) throw new ArgumentException(\"Page number must be greater than 0\", nameof(pageNumber));");
            sb.AppendLine("            if (pageSize < 1) throw new ArgumentException(\"Page size must be greater than 0\", nameof(pageSize));");
            sb.AppendLine("            ");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine("                var query = GetSqlSugarClient().Queryable<" + entity.EntityName + ">()");
            sb.AppendLine("                    .With(SqlWith.NoLock);");
            sb.AppendLine("                ");
            sb.AppendLine("                // 添加排序");
            sb.AppendLine("                if (orderBy != null)");
            sb.AppendLine("                {");
            sb.AppendLine("                    query = isDescending ? query.OrderBy(orderBy, OrderByType.Desc) : query.OrderBy(orderBy, OrderByType.Asc);");
            sb.AppendLine("                }");
            sb.AppendLine("                else");
            sb.AppendLine("                {");
            sb.AppendLine("                    query = query.OrderBy(entity => entity." + entity.PrimaryKeyProperty + ", OrderByType.Desc);");
            sb.AppendLine("                }");
            sb.AppendLine("                ");
            sb.AppendLine("                // 执行分页查询");
            sb.AppendLine("                var totalCount = await query.CountAsync(cancellationToken);");
            sb.AppendLine("                var items = await query.Skip((pageNumber - 1) * pageSize).Take(pageSize).ToListAsync(cancellationToken);");
            sb.AppendLine("                ");
            sb.AppendLine("                return new PaginatedResult<" + entity.EntityName + ">");
            sb.AppendLine("                {");
            sb.AppendLine("                    Items = items,");
            sb.AppendLine("                    TotalCount = totalCount,");
            sb.AppendLine("                    PageNumber = pageNumber,");
            sb.AppendLine("                    PageSize = pageSize,");
            sb.AppendLine("                    TotalPages = (int)Math.Ceiling((double)totalCount / pageSize)");
            sb.AppendLine("                };");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (SqlSugarException ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _logger.LogError(ex, \"分页查询" + entity.EntityDescription + "失败\");");
            sb.AppendLine("                throw new DataAccessException(\"分页查询" + entity.EntityDescription + "失败\", ex);");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            sb.AppendLine("        #endregion");
            sb.AppendLine();
            
            // 类结束
            sb.AppendLine("    }");
            sb.AppendLine("}");
            
            return sb.ToString();
        }
    }
}