using System.Text;
using FakeMicro.Utilities.CodeGenerator.Entities;
using FakeMicro.Utilities.CodeGenerator;

namespace FakeMicro.Utilities.CodeGenerator.Templates
{
    /// <summary>
    /// 仓储Grain实现模板
    /// 专门处理数据访问层的Orleans Grain实现，集成SqlSugar ORM
    /// </summary>
    public static class RepositoryGrainTemplate
    {
        public static string Generate(EntityMetadata entity)
        {
            var sb = new StringBuilder();
            
            // 文件头注释
            sb.AppendLine($"// <auto-generated>");
            sb.AppendLine($"//     此代码由代码生成器生成，请勿手动修改");
            sb.AppendLine($"//     生成时间: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
            sb.AppendLine($"//     功能: {entity.EntityDescription}数据访问Grain实现");
            sb.AppendLine($"// </auto-generated>");
            sb.AppendLine();
            
            // Using语句
            sb.AppendLine("using System;");
            sb.AppendLine("using System.Threading;");
            sb.AppendLine("using System.Threading.Tasks;");
            sb.AppendLine("using System.Collections.Generic;");
            sb.AppendLine("using System.Linq.Expressions;");
            sb.AppendLine("using System.Diagnostics;");
            sb.AppendLine("using Microsoft.Extensions.Logging;");
            sb.AppendLine("using Microsoft.Extensions.DependencyInjection;");
            sb.AppendLine("using Orleans;");
            sb.AppendLine("using Orleans.Runtime;");
            sb.AppendLine("using Orleans.Configuration;");
            sb.AppendLine("using SqlSugar;");
            sb.AppendLine($"using {entity.Namespace}.Models;");
            sb.AppendLine("using FakeMicro.DatabaseAccess;");
            sb.AppendLine("using FakeMicro.DatabaseAccess.Interfaces;");
            sb.AppendLine("using FakeMicro.DatabaseAccess.Exceptions;");
            sb.AppendLine();
            
            // 命名空间
            sb.AppendLine($"namespace {entity.Namespace}.Repository");
            sb.AppendLine("{");
            
            // 仓储Grain接口定义
            sb.AppendLine("    /// <summary>");
            sb.AppendLine($"    /// {entity.EntityDescription}数据访问Repository接口");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine($"    public interface I{entity.EntityName}Repository:IRepository<{entity.EntityName}, long>");
            sb.AppendLine("    {");
            sb.AppendLine($"        /// <summary>");
            sb.AppendLine($"        /// 获取{entity.EntityDescription}实体");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        Task<{entity.EntityName}?> GetAsync();");
            sb.AppendLine();
            sb.AppendLine($"        /// <summary>");
            sb.AppendLine($"        /// 插入{entity.EntityDescription}实体");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        Task<{entity.EntityName}?> InsertAsync({entity.EntityName} entity);");
            sb.AppendLine();
            sb.AppendLine($"        /// <summary>");
            sb.AppendLine($"        /// 更新{entity.EntityDescription}实体");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        Task<{entity.EntityName}?> UpdateAsync({entity.EntityName} entity);");
            sb.AppendLine();
            sb.AppendLine($"        /// <summary>");
            sb.AppendLine($"        /// 删除{entity.EntityDescription}实体");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        Task<bool> DeleteAsync();");
            sb.AppendLine();
            sb.AppendLine($"        /// <summary>");
            sb.AppendLine($"        /// 检查{entity.EntityDescription}是否存在");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        Task<bool> ExistsAsync(Expression<Func<{entity.EntityName}, bool>> predicate);");
            sb.AppendLine();
            sb.AppendLine($"        /// <summary>");
            sb.AppendLine($"        /// 获取{entity.EntityDescription}数量");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        Task<int> CountAsync(Expression<Func<{entity.EntityName}, bool>>? predicate = null);");
            sb.AppendLine();
            
            if (entity.IsSoftDeletable)
            {
                sb.AppendLine($"        /// <summary>");
                sb.AppendLine($"        /// 软删除{entity.EntityDescription}实体");
                sb.AppendLine("        /// </summary>");
                sb.AppendLine($"        Task<bool> SoftDeleteAsync();");
                sb.AppendLine();
            }
            
            sb.AppendLine("    }");
            sb.AppendLine();
            
            // 仓储Grain实现类
            sb.AppendLine("    /// <summary>");
            sb.AppendLine($"    /// {entity.EntityDescription}数据访问Grain实现");
            sb.AppendLine("    /// 集成SqlSugar ORM和Orleans分布式架构");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine($"    public class {entity.EntityName}RepositoryGrain : Grain, I{entity.EntityName}RepositoryGrain");
            sb.AppendLine("    {");
            
            // 字段声明
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// 日志记录器");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        private readonly ILogger<{entity.EntityName}RepositoryGrain> _logger;");
            sb.AppendLine();
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// 数据访问仓储实例");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        private readonly IRepository<{entity.EntityName}, Guid> _repository;");
            sb.AppendLine();
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// 性能监控器");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        private readonly Stopwatch _stopwatch = new();");
            sb.AppendLine();
            
            // 构造函数
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// 构造函数");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public {entity.EntityName}RepositoryGrain(");
            sb.AppendLine($"            ILogger<{entity.EntityName}RepositoryGrain> logger,");
            sb.AppendLine($"            IRepository<{entity.EntityName}, Guid> repository)");
            sb.AppendLine("        {");
            sb.AppendLine("            _logger = logger ?? throw new ArgumentNullException(nameof(logger));");
            sb.AppendLine("            _repository = repository ?? throw new ArgumentNullException(nameof(repository));");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // GetAsync方法实现
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 获取{entity.EntityDescription}实体");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        public async Task<{entity.EntityName}?> GetAsync()");
            sb.AppendLine("        {");
            sb.AppendLine("            _stopwatch.Restart();");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                if (!this.GetPrimaryKey(out Guid grainId))");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogWarning(\"无效的Grain ID: {{GrainId}}\", this.GetPrimaryKeyString());");
            sb.AppendLine("                    return null;");
            sb.AppendLine("                }");
            sb.AppendLine();
            sb.AppendLine($"                _logger.LogDebug(\"开始获取{entity.EntityDescription}实体: {{Id}}\", grainId);");
            sb.AppendLine($"                var result = await _repository.GetByIdAsync(grainId);");
            sb.AppendLine();
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogInformation(\"获取{entity.EntityDescription}实体完成: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    grainId, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine();
            sb.AppendLine("                return result;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (DataAccessException daEx)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(daEx, \"数据访问异常，获取{entity.EntityDescription}实体失败: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    this.GetPrimaryKeyString(), _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(ex, \"获取{entity.EntityDescription}实体时发生未知错误: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    this.GetPrimaryKeyString(), _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw new DataAccessException($\"获取{entity.EntityDescription}实体失败: {this.GetPrimaryKeyString()}\", ex);");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // InsertAsync方法实现
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 插入{entity.EntityDescription}实体");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public async Task<{entity.EntityName}?> InsertAsync({entity.EntityName} entity)");
            sb.AppendLine("        {");
            sb.AppendLine("            if (entity == null)");
            sb.AppendLine("            {");
            sb.AppendLine("                throw new ArgumentNullException(nameof(entity));");
            sb.AppendLine("            }");
            sb.AppendLine();
            sb.AppendLine("            _stopwatch.Restart();");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogDebug(\"开始插入{entity.EntityDescription}实体: {{Id}}\", entity.Id);");
            sb.AppendLine();
            sb.AppendLine("                // 设置默认字段值");
            sb.AppendLine("                var now = DateTime.UtcNow;");
            sb.AppendLine("                if (entity.Id == Guid.Empty)");
            sb.AppendLine("                {");
            sb.AppendLine("                    entity.Id = this.GetPrimaryKey();");
            sb.AppendLine("                }");
            sb.AppendLine("                entity.CreatedAt = entity.CreatedAt == default ? now : entity.CreatedAt;");
            sb.AppendLine("                entity.UpdatedAt = now;");
            sb.AppendLine();
            sb.AppendLine($"                await _repository.AddAsync(entity);");
            sb.AppendLine("                await _repository.SaveChangesAsync();");
            sb.AppendLine();
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogInformation(\"插入{entity.EntityDescription}实体成功: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    entity.Id, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine();
            sb.AppendLine("                return entity;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (SqlSugarException ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                if (ex.Number == 2627) // 唯一键冲突");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogWarning(ex, \"插入{entity.EntityDescription}实体时发生唯一键冲突: {{Id}}\", entity.Id);");
            sb.AppendLine("                    throw new DataAccessException($\"该{entity.EntityDescription}已存在\", ex);");
            sb.AppendLine("                }");
            sb.AppendLine("                else");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogError(ex, \"数据库操作异常，插入{entity.EntityDescription}实体失败: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                        entity.Id, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                    throw new DataAccessException($\"数据库操作失败\", ex);");
            sb.AppendLine("                }");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (DataAccessException daEx)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(daEx, \"数据访问异常，插入{entity.EntityDescription}实体失败: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    entity.Id, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(ex, \"插入{entity.EntityDescription}实体时发生未知错误: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    entity.Id, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw new DataAccessException($\"插入{entity.EntityDescription}实体失败\", ex);");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // UpdateAsync方法实现
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 更新{entity.EntityDescription}实体");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine($"        public async Task<{entity.EntityName}?> UpdateAsync({entity.EntityName} entity)");
            sb.AppendLine("        {");
            sb.AppendLine("            if (entity == null)");
            sb.AppendLine("            {");
            sb.AppendLine("                throw new ArgumentNullException(nameof(entity));");
            sb.AppendLine("            }");
            sb.AppendLine();
            sb.AppendLine("            _stopwatch.Restart();");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogDebug(\"开始更新{entity.EntityDescription}实体: {{Id}}\", entity.Id);");
            sb.AppendLine();
            sb.AppendLine("                // 检查实体是否存在");
            sb.AppendLine("                var existingEntity = await _repository.GetByIdAsync(entity.Id);");
            sb.AppendLine("                if (existingEntity == null)");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogWarning(\"{entity.EntityDescription}实体不存在，无法更新: {{Id}}\", entity.Id);");
            sb.AppendLine("                    throw new DataAccessException($\"{entity.EntityDescription}实体不存在\");");
            sb.AppendLine("                }");
            sb.AppendLine();
            sb.AppendLine("                // 更新字段值");
            sb.AppendLine("                entity.CreatedAt = existingEntity.CreatedAt; // 保持创建时间不变");
            sb.AppendLine("                entity.UpdatedAt = DateTime.UtcNow; // 更新修改时间");
            sb.AppendLine();
            sb.AppendLine($"                await _repository.UpdateAsync(entity);");
            sb.AppendLine("                await _repository.SaveChangesAsync();");
            sb.AppendLine();
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogInformation(\"更新{entity.EntityDescription}实体成功: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    entity.Id, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine();
            sb.AppendLine("                return entity;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (DataAccessException daEx)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(daEx, \"数据访问异常，更新{entity.EntityDescription}实体失败: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    entity.Id, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(ex, \"更新{entity.EntityDescription}实体时发生未知错误: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    entity.Id, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw new DataAccessException($\"更新{entity.EntityDescription}实体失败\", ex);");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // DeleteAsync方法实现
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 删除{entity.EntityDescription}实体");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        public async Task<bool> DeleteAsync()");
            sb.AppendLine("        {");
            sb.AppendLine("            _stopwatch.Restart();");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                if (!this.GetPrimaryKey(out Guid grainId))");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogWarning(\"无效的Grain ID: {{GrainId}}\", this.GetPrimaryKeyString());");
            sb.AppendLine("                    return false;");
            sb.AppendLine("                }");
            sb.AppendLine();
            sb.AppendLine($"                _logger.LogDebug(\"开始删除{entity.EntityDescription}实体: {{Id}}\", grainId);");
            sb.AppendLine();
            sb.AppendLine("                // 检查实体是否存在");
            sb.AppendLine("                var existingEntity = await _repository.GetByIdAsync(grainId);");
            sb.AppendLine("                if (existingEntity == null)");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _logger.LogWarning(\"{entity.EntityDescription}实体不存在，无法删除: {{Id}}\", grainId);");
            sb.AppendLine("                    return false;");
            sb.AppendLine("                }");
            sb.AppendLine();
            sb.AppendLine($"                await _repository.DeleteAsync(existingEntity);");
            sb.AppendLine("                await _repository.SaveChangesAsync();");
            sb.AppendLine();
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogInformation(\"删除{entity.EntityDescription}实体成功: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    grainId, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine();
            sb.AppendLine("                return true;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (DataAccessException daEx)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(daEx, \"数据访问异常，删除{entity.EntityDescription}实体失败: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    this.GetPrimaryKeyString(), _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(ex, \"删除{entity.EntityDescription}实体时发生未知错误: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    this.GetPrimaryKeyString(), _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw new DataAccessException($\"删除{entity.EntityDescription}实体失败\", ex);");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // ExistsAsync方法实现
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 检查{entity.EntityDescription}是否存在");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        public async Task<bool> ExistsAsync(Expression<Func<{entity.EntityName}, bool>> predicate)");
            sb.AppendLine("        {");
            sb.AppendLine("            if (predicate == null)");
            sb.AppendLine("            {");
            sb.AppendLine("                throw new ArgumentNullException(nameof(predicate));");
            sb.AppendLine("            }");
            sb.AppendLine();
            sb.AppendLine("            _stopwatch.Restart();");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogDebug(\"开始检查{entity.EntityDescription}实体是否存在\");");
            sb.AppendLine();
            sb.AppendLine($"                var result = await _repository.ExistsAsync(predicate);");
            sb.AppendLine();
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogInformation(\"检查{entity.EntityDescription}实体是否存在完成: {{Exists}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    result, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine();
            sb.AppendLine("                return result;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(ex, \"检查{entity.EntityDescription}实体是否存在时发生错误, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw new DataAccessException($\"检查{entity.EntityDescription}实体是否存在失败\", ex);");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // CountAsync方法实现
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// 获取{entity.EntityDescription}数量");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        public async Task<int> CountAsync(Expression<Func<{entity.EntityName}, bool>>? predicate = null)");
            sb.AppendLine("        {");
            sb.AppendLine("            _stopwatch.Restart();");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine($"                _logger.LogDebug(\"开始获取{entity.EntityDescription}实体数量\");");
            sb.AppendLine();
            sb.AppendLine("                var result = await _repository.CountAsync(predicate);");
            sb.AppendLine();
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogInformation(\"获取{entity.EntityDescription}实体数量完成: {{Count}}, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    result, _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine();
            sb.AppendLine("                return result;");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _stopwatch.Stop();");
            sb.AppendLine($"                _logger.LogError(ex, \"获取{entity.EntityDescription}实体数量时发生错误, 耗时: {{ElapsedMs}}ms\", ");
            sb.AppendLine("                    _stopwatch.ElapsedMilliseconds);");
            sb.AppendLine("                throw new DataAccessException($\"获取{entity.EntityDescription}实体数量失败\", ex);");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            
            // 软删除方法实现
            if (entity.IsSoftDeletable)
            {
                sb.AppendLine("        /// <summary>");
                sb.AppendLine($"        /// 软删除{entity.EntityDescription}实体");
                sb.AppendLine("        /// </summary>");
                sb.AppendLine("        public async Task<bool> SoftDeleteAsync()");
                sb.AppendLine("        {");
                sb.AppendLine("            _stopwatch.Restart();");
                sb.AppendLine("            try");
                sb.AppendLine("            {");
                sb.AppendLine($"                if (!this.GetPrimaryKey(out Guid grainId))");
                sb.AppendLine("                {");
                sb.AppendLine($"                    _logger.LogWarning(\"无效的Grain ID: {{GrainId}}\", this.GetPrimaryKeyString());");
                sb.AppendLine("                    return false;");
                sb.AppendLine("                }");
                sb.AppendLine();
                sb.AppendLine($"                _logger.LogDebug(\"开始软删除{entity.EntityDescription}实体: {{Id}}\", grainId);");
                sb.AppendLine();
                sb.AppendLine("                // 获取实体并执行软删除");
                sb.AppendLine("                var existingEntity = await _repository.GetByIdAsync(grainId);");
                sb.AppendLine("                if (existingEntity == null)");
                sb.AppendLine("                {");
                sb.AppendLine($"                    _logger.LogWarning(\"{entity.EntityDescription}实体不存在，无法软删除: {{Id}}\", grainId);");
                sb.AppendLine("                    return false;");
                sb.AppendLine("                }");
                sb.AppendLine();
                sb.AppendLine("                // 标记为已删除");
                sb.AppendLine("                existingEntity.IsDeleted = true;");
                sb.AppendLine("                existingEntity.DeletedAt = DateTime.UtcNow;");
                sb.AppendLine("                existingEntity.UpdatedAt = DateTime.UtcNow;");
                sb.AppendLine();
                sb.AppendLine($"                await _repository.UpdateAsync(existingEntity);");
                sb.AppendLine("                await _repository.SaveChangesAsync();");
                sb.AppendLine();
                sb.AppendLine("                _stopwatch.Stop();");
                sb.AppendLine($"                _logger.LogInformation(\"软删除{entity.EntityDescription}实体成功: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
                sb.AppendLine("                    grainId, _stopwatch.ElapsedMilliseconds);");
                sb.AppendLine();
                sb.AppendLine("                return true;");
                sb.AppendLine("            }");
                sb.AppendLine("            catch (DataAccessException daEx)");
                sb.AppendLine("            {");
                sb.AppendLine("                _stopwatch.Stop();");
                sb.AppendLine($"                _logger.LogError(daEx, \"数据访问异常，软删除{entity.EntityDescription}实体失败: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
                sb.AppendLine("                    this.GetPrimaryKeyString(), _stopwatch.ElapsedMilliseconds);");
                sb.AppendLine("                throw;");
                sb.AppendLine("            }");
                sb.AppendLine("            catch (Exception ex)");
                sb.AppendLine("            {");
                sb.AppendLine("                _stopwatch.Stop();");
                sb.AppendLine($"                _logger.LogError(ex, \"软删除{entity.EntityDescription}实体时发生未知错误: {{Id}}, 耗时: {{ElapsedMs}}ms\", ");
                sb.AppendLine("                    this.GetPrimaryKeyString(), _stopwatch.ElapsedMilliseconds);");
                sb.AppendLine("                throw new DataAccessException($\"软删除{entity.EntityDescription}实体失败\", ex);");
                sb.AppendLine("            }");
                sb.AppendLine("        }");
                sb.AppendLine();
            }
            
            // 结束类定义
            sb.AppendLine("    }");
            sb.AppendLine("}");
            
            return sb.ToString();
        }
    }
}