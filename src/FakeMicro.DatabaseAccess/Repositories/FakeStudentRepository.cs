// <auto-generated>
//     此代码由代码生成器生成，请勿手动修改
//     生成时间: 2025-11-20 22:08:21
//     功能: FakeStudent仓储实现类
//     架构: 遵循Orleans最佳实践，继承SqlSugarRepository
// </auto-generated>

#nullable disable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using SqlSugar;
using FakeMicro.DatabaseAccess;
using FakeMicro.DatabaseAccess.Interfaces;
using FakeMicro.Entities;
using FakeMicro.Interfaces.Models;
using FakeMicro.Shared.Exceptions;

namespace FakeMicro.DatabaseAccess.Repositories
{
    /// <summary>
    /// FakeStudent仓储实现类
    /// 继承SqlSugarRepository，遵循Orleans架构最佳实践
    /// </summary>
    public class FakeStudentRepository : SqlSugarRepository<FakeStudent, long>, IFakeStudentRepository
    {
        private readonly ILogger<FakeStudentRepository> _logger;

        /// <summary>
        /// FakeStudent仓储构造函数
        /// </summary>
        /// <param name="db">SqlSugar数据库客户端</param>
        /// <param name="logger">日志记录器</param>
        public FakeStudentRepository(ISqlSugarClient db, ILogger<FakeStudentRepository> logger)
            : base(db, logger)
        {
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        }

        #region 基类方法重写

        /// <summary>
        /// 重写获取FakeStudent方法，添加性能优化
        /// </summary>
        /// <param name="id">主键值</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>FakeStudent实体</returns>
        public new async virtual Task<FakeStudent?> GetByIdAsync(long id, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            try
            {
                // 使用SqlSugar的查询优化，添加WITH(NOLOCK)提示
                return await GetSqlSugarClient().Queryable<FakeStudent>()
                    .With(SqlWith.NoLock)
                    .Where(entity => entity.Id == id)
                    .FirstAsync(cancellationToken);
            }
            catch (SqlSugarException ex)
            {
                _logger.LogError(ex, "获取FakeStudent失败: {Id}", id);
                throw new DataAccessException("获取FakeStudent失败: " + id, ex);
            }
        }

        /// <summary>
        /// 创建FakeStudent并返回创建后的实体
        /// </summary>
        /// <param name="entity">FakeStudent实体</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>创建后的FakeStudent实体</returns>
        public async virtual Task<FakeStudent?> CreateAndReturnAsync(FakeStudent entity, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            if (entity == null) throw new ArgumentNullException(nameof(entity));
            
            try
            {
                var result = await GetSqlSugarClient().Insertable(entity).ExecuteReturnEntityAsync();
                _logger.LogInformation("成功创建{EntityName}: {Id}", typeof(FakeStudent).Name, result.Id);
                return result;
            }
            catch (SqlSugarException ex)
            {
                _logger.LogError(ex, "创建FakeStudent失败");
                throw new DataAccessException("创建FakeStudent失败", ex);
            }
        }

        /// <summary>
        /// 更新FakeStudent并返回更新后的实体
        /// </summary>
        /// <param name="entity">FakeStudent实体</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>更新后的FakeStudent实体</returns>
        public async virtual Task<FakeStudent?> UpdateAndReturnAsync(FakeStudent entity, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            if (entity == null) throw new ArgumentNullException(nameof(entity));
            
            try
            {
                var result = await GetSqlSugarClient().Updateable(entity).ExecuteReturnEntityAsync();
                _logger.LogInformation("成功更新{EntityName}: {Id}", typeof(FakeStudent).Name, entity.Id);
                return result;
            }
            catch (SqlSugarException ex)
            {
                _logger.LogError(ex, "更新FakeStudent失败");
                throw new DataAccessException("更新FakeStudent失败", ex);
            }
        }

        /// <summary>
        /// 批量创建FakeStudent并返回创建后的实体列表
        /// </summary>
        /// <param name="entities">FakeStudent实体集合</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>创建后的FakeStudent实体列表</returns>
        public async virtual Task<IEnumerable<FakeStudent>?> CreateRangeAndReturnAsync(IEnumerable<FakeStudent> entities, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            if (entities == null) throw new ArgumentNullException(nameof(entities));
            var entityList = entities.ToList();
            if (!entityList.Any()) return Enumerable.Empty<FakeStudent>();
            
            try
            {
                var affectedRows = await GetSqlSugarClient().Insertable(entityList).ExecuteCommandAsync(cancellationToken);
                _logger.LogInformation("成功批量创建FakeStudent，数量: {Count}", affectedRows);
                return entityList;
            }
            catch (SqlSugarException ex)
            {
                _logger.LogError(ex, "批量创建FakeStudent失败，数量: {Count}", entityList.Count);
                throw new DataAccessException("批量创建FakeStudent失败", ex);
            }
        }

        #endregion

        #region Orleans Grain特定操作

        /// <summary>
        /// 通过Grain ID获取FakeStudent（Orleans特定）
        /// </summary>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>FakeStudent实体</returns>
        public async virtual Task<FakeStudent?> GetByGrainIdAsync(CancellationToken cancellationToken = default)
        {
            // 注意：此方法需要在Grain上下文中调用，通过Grain的ID获取实体
            // 具体实现取决于Grain的ID策略
            throw new NotImplementedException("需要在Grain上下文中实现GetByGrainIdAsync方法");
        }

        /// <summary>
        /// 创建FakeStudent（Orleans特定）
        /// </summary>
        /// <param name="entity">FakeStudent实体</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>创建后的FakeStudent实体</returns>
        public async virtual Task<FakeStudent> CreateAsync(FakeStudent entity, CancellationToken cancellationToken = default)
        {
            return await CreateAndReturnAsync(entity, cancellationToken);
        }

        #endregion

        #region 同步方法包装

        /// <summary>
        /// 同步更新方法（包装异步方法）
        /// </summary>
        public void Update(FakeStudent entity)
        {
            UpdateAsync(entity).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步批量更新方法（包装异步方法）
        /// </summary>
        public void UpdateRange(IEnumerable<FakeStudent> entities)
        {
            UpdateRangeAsync(entities).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步删除方法（包装异步方法）
        /// </summary>
        public void Delete(FakeStudent entity)
        {
            DeleteAsync(entity).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步批量删除方法（包装异步方法）
        /// </summary>
        public void DeleteRange(IEnumerable<FakeStudent> entities)
        {
            DeleteRangeAsync(entities).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步部分更新方法（包装异步方法）
        /// </summary>
        public void UpdatePartial(FakeStudent entity, params Expression<Func<FakeStudent, object>>[] properties)
        {
            UpdatePartialAsync(entity, properties).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 基于属性的同步方法适配器
        /// </summary>
        /// <summary>
        /// 同步获取FakeStudent（根据ClassName）
        /// </summary>
        public FakeStudent? GetByClassName(string classname)
        {
            return GetByClassNameAsync(classname).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步检查ClassName是否存在
        /// </summary>
        public bool ClassNameExists(string classname, long excludeId = default)
        {
            return ClassNameExistsAsync(classname, excludeId).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步获取FakeStudent（根据ClassCode）
        /// </summary>
        public FakeStudent? GetByClassCode(string classcode)
        {
            return GetByClassCodeAsync(classcode).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步检查ClassCode是否存在
        /// </summary>
        public bool ClassCodeExists(string classcode, long excludeId = default)
        {
            return ClassCodeExistsAsync(classcode, excludeId).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步获取FakeStudent（根据Major）
        /// </summary>
        public FakeStudent? GetByMajor(string major)
        {
            return GetByMajorAsync(major).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步检查Major是否存在
        /// </summary>
        public bool MajorExists(string major, long excludeId = default)
        {
            return MajorExistsAsync(major, excludeId).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步获取FakeStudent（根据Description）
        /// </summary>
        public FakeStudent? GetByDescription(string description)
        {
            return GetByDescriptionAsync(description).GetAwaiter().GetResult();
        }

        /// <summary>
        /// 同步检查Description是否存在
        /// </summary>
        public bool DescriptionExists(string description, long excludeId = default)
        {
            return DescriptionExistsAsync(description, excludeId).GetAwaiter().GetResult();
        }

        #endregion

        #region 分页查询方法

        /// <summary>
        /// 分页查询FakeStudent（Orleans接口兼容）
        /// </summary>
        /// <param name="pageNumber">页码（从1开始）</param>
        /// <param name="pageSize">页大小</param>
        /// <param name="orderBy">排序表达式（可选）</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>分页结果</returns>
        public async virtual Task<PagedResult<FakeStudent>> GetPagedAsync(int pageNumber, int pageSize, 
            Expression<Func<FakeStudent, object>>? orderBy = null, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            if (pageNumber < 1) pageNumber = 1;
            if (pageSize < 1) pageSize = 20;
            
            try
            {
                // 使用基类的分页方法
                var orderByExpression = orderBy ?? (x => x.Id);
                var result = await base.GetPagedAsync(pageNumber, pageSize, orderByExpression, false, cancellationToken);
                _logger.LogInformation("成功获取FakeStudent分页数据，页码: {PageNumber}, 页大小: {PageSize}", pageNumber, pageSize);
                return result;
            }
            catch (SqlSugarException ex)
            {
                _logger.LogError(ex, "获取FakeStudent分页数据失败，页码: {PageNumber}, 页大小: {PageSize}", pageNumber, pageSize);
                throw new DataAccessException("获取FakeStudent分页数据失败", ex);
            }
        }

        /// <summary>
        /// 条件分页查询FakeStudent（Orleans接口兼容）
        /// </summary>
        /// <param name="predicate">查询条件</param>
        /// <param name="pageNumber">页码（从1开始）</param>
        /// <param name="pageSize">页大小</param>
        /// <param name="orderBy">排序表达式（可选）</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>分页结果</returns>
        public async virtual Task<PagedResult<FakeStudent>> GetPagedByConditionAsync(
            Expression<Func<FakeStudent, bool>> predicate, int pageNumber, int pageSize,
            Expression<Func<FakeStudent, object>>? orderBy = null, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            if (pageNumber < 1) pageNumber = 1;
            if (pageSize < 1) pageSize = 20;
            if (predicate == null) throw new ArgumentNullException(nameof(predicate));
            
            try
            {
                // 使用基类的条件分页方法
                var orderByExpression = orderBy ?? (x => x.Id);
                var result = await base.GetPagedByConditionAsync(predicate, pageNumber, pageSize, orderByExpression, false, cancellationToken);
                _logger.LogInformation("成功获取FakeStudent条件分页数据，页码: {PageNumber}, 页大小: {PageSize}", pageNumber, pageSize);
                return result;
            }
            catch (SqlSugarException ex)
            {
                _logger.LogError(ex, "获取\"{EntityName}\"条件分页数据失败，页码: {PageNumber}, 页大小: {PageSize}", "FakeStudent", pageNumber, pageSize);
                throw new DataAccessException("获取FakeStudent条件分页数据失败", ex);
            }
        }

        #endregion

        #region 业务查询方法

        /// <summary>
        /// 根据ClassName查询FakeStudent
        /// </summary>
        /// <param name="classname">ClassName</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>FakeStudent实体</returns>
        public async Task<FakeStudent?> GetByClassNameAsync(string classname, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            try
            {
                return await GetSqlSugarClient().Queryable<FakeStudent>()
                    .Where(entity => entity.ClassName == classname)
                    .FirstAsync();
            }
            catch (SqlSugarException ex)
            {
                throw new Exception($"根据ClassName获取FakeStudent失败: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// 检查ClassName是否存在
        /// </summary>
        /// <param name="classname">ClassName</param>
        /// <param name="excludeId">排除的ID（用于更新时验证）</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>是否存在</returns>
        public async Task<bool> ClassNameExistsAsync(string classname, long excludeId = default, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            try
            {
                var query = GetSqlSugarClient().Queryable<FakeStudent>()
                    .Where(entity => entity.ClassName == classname);
                
                if (!excludeId.Equals(default(long)))
                {
                    query = query.Where(entity => entity.Id != excludeId);
                }
                
                var count = await query.CountAsync();
                return count > 0;
            }
            catch (SqlSugarException ex)
            {
                throw new Exception($"检查FakeStudentClassName是否存在失败: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// 根据ClassCode查询FakeStudent
        /// </summary>
        /// <param name="classcode">ClassCode</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>FakeStudent实体</returns>
        public async Task<FakeStudent?> GetByClassCodeAsync(string classcode, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            try
            {
                return await GetSqlSugarClient().Queryable<FakeStudent>()
                    .Where(entity => entity.ClassCode == classcode)
                    .FirstAsync();
            }
            catch (SqlSugarException ex)
            {
                throw new Exception($"根据ClassCode获取FakeStudent失败: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// 检查ClassCode是否存在
        /// </summary>
        /// <param name="classcode">ClassCode</param>
        /// <param name="excludeId">排除的ID（用于更新时验证）</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>是否存在</returns>
        public async Task<bool> ClassCodeExistsAsync(string classcode, long excludeId = default, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            try
            {
                var query = GetSqlSugarClient().Queryable<FakeStudent>()
                    .Where(entity => entity.ClassCode == classcode);
                
                if (!excludeId.Equals(default(long)))
                {
                    query = query.Where(entity => entity.Id != excludeId);
                }
                
                var count = await query.CountAsync();
                return count > 0;
            }
            catch (SqlSugarException ex)
            {
                throw new Exception($"检查FakeStudentClassCode是否存在失败: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// 根据Major查询FakeStudent
        /// </summary>
        /// <param name="major">Major</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>FakeStudent实体</returns>
        public async Task<FakeStudent?> GetByMajorAsync(string major, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            try
            {
                return await GetSqlSugarClient().Queryable<FakeStudent>()
                    .Where(entity => entity.Major == major)
                    .FirstAsync();
            }
            catch (SqlSugarException ex)
            {
                throw new Exception($"根据Major获取FakeStudent失败: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// 检查Major是否存在
        /// </summary>
        /// <param name="major">Major</param>
        /// <param name="excludeId">排除的ID（用于更新时验证）</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>是否存在</returns>
        public async Task<bool> MajorExistsAsync(string major, long excludeId = default, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            try
            {
                var query = GetSqlSugarClient().Queryable<FakeStudent>()
                    .Where(entity => entity.Major == major);
                
                if (!excludeId.Equals(default(long)))
                {
                    query = query.Where(entity => entity.Id != excludeId);
                }
                
                var count = await query.CountAsync();
                return count > 0;
            }
            catch (SqlSugarException ex)
            {
                throw new Exception($"检查FakeStudentMajor是否存在失败: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// 根据Description查询FakeStudent
        /// </summary>
        /// <param name="description">Description</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>FakeStudent实体</returns>
        public async Task<FakeStudent?> GetByDescriptionAsync(string description, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            try
            {
                return await GetSqlSugarClient().Queryable<FakeStudent>()
                    .Where(entity => entity.Description == description)
                    .FirstAsync();
            }
            catch (SqlSugarException ex)
            {
                throw new Exception($"根据Description获取FakeStudent失败: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// 检查Description是否存在
        /// </summary>
        /// <param name="description">Description</param>
        /// <param name="excludeId">排除的ID（用于更新时验证）</param>
        /// <param name="cancellationToken">取消令牌</param>
        /// <returns>是否存在</returns>
        public async Task<bool> DescriptionExistsAsync(string description, long excludeId = default, CancellationToken cancellationToken = default)
        {
            cancellationToken.ThrowIfCancellationRequested();
            try
            {
                var query = GetSqlSugarClient().Queryable<FakeStudent>()
                    .Where(entity => entity.Description == description);
                
                if (!excludeId.Equals(default(long)))
                {
                    query = query.Where(entity => entity.Id != excludeId);
                }
                
                var count = await query.CountAsync();
                return count > 0;
            }
            catch (SqlSugarException ex)
            {
                throw new Exception($"检查FakeStudentDescription是否存在失败: {ex.Message}", ex);
            }
        }

        #endregion

    }
}