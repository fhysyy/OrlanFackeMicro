# 项目内容整理

## 一、项目概述

本项目基于Orleans框架和SqlSugar ORM框架实现了一个完整的分布式数据访问层，遵循领域驱动设计（DDD）原则，提供了高性能、可扩展、可维护的数据访问解决方案。

### 核心价值
- **分布式架构**：基于Orleans的分布式Grain模式，实现高可用、可扩展的数据访问
- **统一数据访问**：同时支持PostgreSQL和MongoDB，提供一致的仓储接口
- **高性能**：集成智能缓存、批量操作、查询优化等性能特性
- **可维护性**：遵循DDD和SOLID原则，代码结构清晰，易于扩展

## 二、技术栈

| 技术领域 | 技术名称 | 版本 | 用途 |
|---------|---------|------|------|
| 核心框架 | Orleans | 9.2.1 | 分布式应用框架，提供Grain编程模型 |
| ORM框架 | SqlSugar | 5.1.4.157 | PostgreSQL数据访问ORM |
| 数据库 | PostgreSQL | 9.0.4 (Npgsql驱动) | 关系型数据库存储 |
| NoSQL | MongoDB | - | 文档型数据库存储（支持） |
| 工具库 | Mapster | 7.4.0 | 对象映射工具 |
| 工具库 | System.Text.Json | 10.0.0 | JSON序列化/反序列化 |
| 框架 | ASP.NET Core | - | Web API开发框架 |

## 三、项目结构

```
src/
├── FakeMicro.Api/                    # API接口层
│   ├── Controllers/                  # API控制器
│   ├── Middleware/                   # 中间件
│   ├── Models/                       # 请求/响应模型
│   └── Program.cs                    # API入口
├── FakeMicro.Configuration/          # 配置管理
├── FakeMicro.DatabaseAccess/         # 数据访问层
│   ├── Interfaces/                   # 仓储接口定义
│   ├── Repositories/                 # 仓储实现
│   ├── Transaction/                  # 事务管理
│   └── Services/                     # 数据服务
├── FakeMicro.Entities/               # 实体定义
│   ├── Email/                        # Email相关实体
│   ├── Enums/                        # 枚举定义
│   └── *.cs                          # 业务实体
├── FakeMicro.Grains/                 # Orleans Grain实现
│   ├── Email/                        # Email相关Grain
│   └── *.cs                          # 业务Grain
├── FakeMicro.Interfaces/             # 接口定义
│   ├── Models/                       # 接口模型
│   └── *.cs                          # 业务接口
├── FakeMicro.Shared/                 # 共享组件
│   └── Exceptions/                   # 异常定义
├── FakeMicro.Silo/                   # Orleans Silo服务
│   ├── Program.cs                    # Silo入口
│   └── Startup.cs                    # Silo配置
└── FakeMicro.Utilities/              # 工具类库
    └── CodeGenerator/                # 代码生成器
```

## 四、核心架构设计

### 1. 仓储层架构

#### 接口层次
```
IBaseRepository<TEntity, TKey>  # 基础仓储接口，提供核心CRUD操作
        ↑
IRepository<TEntity, TKey>      # 扩展仓储接口，提供高级功能
        ↑
ISqlRepository<TEntity, TKey>   # PostgreSQL特定接口（规划中）
        ↑
SqlSugarRepository<TEntity, TKey>  # PostgreSQL仓储实现

IBaseRepository<TEntity, TKey>  # 基础仓储接口
        ↑
IMongoRepository<TEntity, TKey> # MongoDB特定接口
        ↑
MongoRepository<TEntity, TKey>  # MongoDB仓储实现
```

#### 核心接口功能

##### IBaseRepository（基础接口）
- 基础CRUD操作：GetByIdAsync、GetAllAsync、AddAsync、UpdateAsync、DeleteByIdAsync
- 分页查询：GetPagedAsync、GetPagedByConditionAsync
- 条件查询：GetByConditionAsync
- 存在性检查：ExistsAsync

##### IRepository（扩展接口）
- 批量操作：AddBatchedAsync、DeleteBatchedAsync
- 部分更新：UpdatePartialAsync
- 批量更新/删除：UpdateRangeAsync、DeleteRangeAsync
- 条件删除：DeleteByConditionAsync
- 事务支持：ExecuteInTransactionAsync
- 实体跟踪：DisableTracking、EnableTracking、ClearTracker
- 更改保存：SaveChangesAsync

### 2. 事务管理

- **SqlSugar事务**：基于SqlSugar的UseTranAsync实现
- **MongoDB事务**：基于MongoDB会话机制实现
- **分布式事务**：通过Orleans Grain协调实现
- **事务特性**：
  - 支持嵌套事务
  - 自动重试机制
  - 完善的异常处理
  - 详细的日志记录

### 3. 缓存机制

- **智能缓存**：自动缓存查询结果，数据变更时自动清除相关缓存
- **多级缓存**：支持内存缓存和分布式缓存
- **缓存一致性**：维护实体类型与缓存键的关联关系，确保数据一致性

## 五、主要功能模块

### 1. 数据访问功能
- **完整CRUD操作**：支持所有基础数据操作
- **高级查询**：支持复杂条件查询、排序、分页
- **批量操作**：高效处理大量数据的批量插入、更新、删除
- **事务支持**：确保数据操作的原子性、一致性、隔离性和持久性

### 2. 分布式功能
- **Orleans Grain**：基于Grain的分布式数据访问单元
- **分布式事务**：跨Grain的事务协调
- **集群支持**：Orleans集群部署，实现高可用

### 3. 性能优化
- **智能缓存**：减少数据库查询次数
- **批量操作**：减少网络往返次数
- **查询优化**：SQL查询优化和索引建议
- **连接池管理**：自动管理数据库连接池

### 4. 监控与诊断
- **性能监控**：内置性能监控和执行时间统计
- **日志记录**：详细的操作日志和错误日志
- **健康检查**：数据库连接健康检查
- **异常处理**：完善的异常处理和恢复机制

## 六、实体模型

主要实体包括：

- **用户相关**：User、UserRole、Role
- **内容相关**：FakeNews、FakeStudent、Note、NoteTag、Notebook
- **系统相关**：AuditLog、DictionaryItem、DictionaryType、FileInfo
- **邮件相关**：Email（位于Email目录下）
- **配置相关**：FormConfig、ManagerVersion
- **消息相关**：Message

## 七、代码生成器

### 1. 功能概述

代码生成器是项目的核心工具之一，能够自动生成以下代码：

- **Orleans Grain接口**：定义Grain操作契约
- **Grain实现类**：实现业务逻辑和数据访问
- **数据传输对象(DTO)**：API数据模型
- **Web API控制器**：HTTP接口层

### 2. 使用方式

#### 程序化调用

```csharp
// 注入代码生成器
public class MyService
{
    private readonly CodeGenerator _codeGenerator;
    
    public MyService(CodeGenerator codeGenerator)
    {
        _codeGenerator = codeGenerator;
    }
    
    public async Task GenerateProductCode()
    {
        var result = await _codeGenerator.GenerateCodeAsync(
            "Product", 
            GenerationType.All
        );
        
        if (result.IsSuccess)
        {
            Console.WriteLine($"生成了 {result.GeneratedFiles.Count} 个文件");
        }
        else
        {
            Console.WriteLine($"生成失败: {result.ErrorMessage}");
        }
    }
}
```

#### 命令行使用

```bash
# 生成所有类型的代码
dotnet run --project FakeMicro.Utilities.csproj -- --generate Product

# 生成特定类型
dotnet run --project FakeMicro.Utilities.csproj -- --generate User Interface Grain

# 列出所有可用实体
dotnet run --project FakeMicro.Utilities.csproj -- --list

# 预览生成的代码
dotnet run --project FakeMicro.Utilities.csproj -- --preview Product
```

### 3. 配置选项

```json
{
  "BaseNamespace": "FakeMicro",
  "AuthorName": "代码生成器",
  "UseUtcTime": true,
  "OverwriteExisting": false,
  "GenerateServiceClasses": true,
  "OutputDirectories": {
    "Interface": "src/FakeMicro.Interfaces",
    "Grain": "src/FakeMicro.Grains", 
    "Dto": "src/FakeMicro.Entities",
    "Controller": "src/FakeMicro.Api"
  }
}
```

### 4. 生成代码特性

#### Interface特性
- ✅ 支持异步操作
- ✅ 包含完整的CRUD方法
- ✅ 支持批量操作
- ✅ 提供搜索和统计功能
- ✅ Orleans特性注解
- ✅ 详细的XML文档注释

#### Grain特性
- ✅ 依赖注入支持
- ✅ SqlSugar仓储集成
- ✅ 完整的错误处理
- ✅ 结构化日志记录
- ✅ 异步编程模式
- ✅ 性能优化

#### Controller特性
- ✅ RESTful API设计
- ✅ 完整的HTTP状态码处理
- ✅ 输入验证
- ✅ 异常处理
- ✅ API文档注释

## 八、构建与运行

### 1. 项目构建

```bash
# 构建整个解决方案
dotnet build src/OrlanFackeMicro.sln

# 构建特定项目
dotnet build src/FakeMicro.DatabaseAccess/FakeMicro.DatabaseAccess.csproj
```

### 2. 运行应用

#### 运行API服务

```bash
# 启动API服务
dotnet run --project src/FakeMicro.Api/FakeMicro.Api.csproj
```

#### 运行Orleans Silo

```bash
# 启动Orleans Silo
dotnet run --project src/FakeMicro.Silo/FakeMicro.Silo.csproj
```

### 3. 测试验证

当前项目中尚未实现独立的测试项目，但代码生成器提供了测试框架支持。项目包含以下测试相关功能：

- **异常测试控制器**：`ExceptionTestController`用于验证全局异常处理机制
- **代码生成器测试**：代码生成器自身包含完整的测试套件
- **API测试端点**：提供用于测试API功能的端点

#### 测试准备（规划）

```bash
# 创建测试项目
mkdir FakeMicro.Tests
cd FakeMicro.Tests
dotnet new xunit

# 添加测试依赖
dotnet add package xunit
```

#### 测试示例（规划）

```csharp
// 仓储单元测试示例
[Fact]
public async Task CompleteCRUD_WithValidEntity_ExecutesSuccessfully()
{
    // 创建测试数据
    var product = CreateTestProduct();
    
    // 插入
    await _repository.AddAsync(product);
    await _repository.SaveChangesAsync();
    
    // 查询
    var retrieved = await _repository.GetByIdAsync(product.Id);
    Assert.NotNull(retrieved);
    
    // 更新
    retrieved.Name = "Updated Product";
    await _repository.UpdateAsync(retrieved);
    await _repository.SaveChangesAsync();
    
    // 验证更新
    var updated = await _repository.GetByIdAsync(product.Id);
    Assert.Equal("Updated Product", updated.Name);
    
    // 删除
    await _repository.DeleteAsync(updated);
    await _repository.SaveChangesAsync();
    
    // 验证删除
    var deleted = await _repository.GetByIdAsync(product.Id);
    Assert.Null(deleted);
}
```

# 运行单元测试
dotnet test src/FakeMicro.Tests/FakeMicro.Tests.csproj

# 查看测试覆盖范围
dotnet test --collect:"XPlat Code Coverage"
```

## 九、最佳实践

### 1. 仓储使用最佳实践
- 优先使用`IRepository`接口获取完整功能
- 对于NoSQL数据库，使用`IBaseRepository`或特定数据库接口
- 合理使用事务确保数据一致性
- 利用缓存提高查询性能

### 2. 性能优化建议
- 对频繁查询的热点数据使用缓存
- 使用分页查询处理大数据集
- 批量处理大量数据操作
- 避免不必要的关联查询

### 3. 异常处理
- 使用特定的数据访问异常（如DataAccessException）
- 实现适当的重试机制处理可重试异常
- 记录详细的错误日志便于诊断

### 4. 事务管理
- 保持事务尽可能短
- 合理设置事务隔离级别
- 确保事务中所有操作都有适当的错误处理

## 十、部署与配置

### 开发环境配置

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=devdb;Username=postgres;Password=password"
  },
  "Orleans": {
    "UseDevelopmentCluster": true,
    "ApplicationAssembly": "FakeMicro"
  },
  "Cache": {
    "EnableCaching": true,
    "Providers": ["Memory"]
  },
  "CodeGenerator": {
    "BaseNamespace": "FakeMicro",
    "OverwriteExisting": false
  }
}
```

### 生产环境配置

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=prod-db;Port=5432;Database=proddb;Username=app_user;Password=***"
  },
  "Orleans": {
    "UseDevelopmentCluster": false,
    "UseDatabaseClustering": true,
    "ClusterId": "ProdCluster",
    "ServiceId": "FakeMicroService"
  },
  "Cache": {
    "EnableCaching": true,
    "Providers": ["Memory", "Distributed"],
    "RedisOptions": {
      "Configuration": "redis-server:6379"
    }
  },
  "CodeGenerator": {
    "BaseNamespace": "FakeMicro",
    "OverwriteExisting": false
  }
}
```

## 十一、监控与诊断

### 1. 日志记录

项目使用结构化日志记录系统，记录所有关键操作：

```csharp
// 日志示例
_logger.LogInformation(
    "查询执行完成: {Operation}, 耗时: {ElapsedMs}ms, 实体类型: {EntityType}",
    "GetByIdAsync", 
    stopwatch.ElapsedMilliseconds, 
    typeof(TEntity).Name
);

_logger.LogError(
    exception, "数据库操作失败: {Operation}, 实体类型: {EntityType}, 错误信息: {Message}",
    "UpdateAsync", 
    typeof(TEntity).Name, 
    exception.Message
);
```

### 2. 性能监控

项目内置性能监控工具，可监控以下指标：

- 数据库查询执行时间
- API响应时间
- 缓存命中率
- 事务成功率

```csharp
// 性能监控示例
public async Task<TEntity?> GetByIdAsync(TKey id)
{
    using var monitor = _performanceMonitor.BeginOperation(nameof(GetByIdAsync));
    try
    {
        // 查询操作
        var result = await _repository.GetByIdAsync(id);
        monitor.Success();
        return result;
    }
    catch (Exception ex)
    {
        monitor.Failure(ex);
        throw;
    }
}
```

### 3. 健康检查

项目提供数据库连接健康检查：

```csharp
// 注册健康检查
services.AddHealthChecks()
    .AddPostgreSql(_configuration.GetConnectionString("DefaultConnection"))
    .AddOrleansCluster();

// 暴露健康检查端点
app.MapHealthChecks("/health");
```

## 十二、未来规划

- 完成RDB和MongoDB仓储接口分离
- 支持更多数据库类型（MySQL、SQL Server等）
- 添加水平分片支持
- 增强缓存策略，支持更复杂的缓存逻辑
- 支持CQRS模式
- 完善代码生成器，支持更多自定义选项

## 十三、总结

本项目实现了一个功能完整、架构先进的分布式数据访问层，结合了Orleans的分布式能力和SqlSugar的ORM优势，为企业级应用提供了可靠的数据访问解决方案。项目遵循最佳实践，具有良好的可扩展性和可维护性，可以满足各种复杂业务场景的需求。