// <auto-generated>
//     此代码由代码生成器生成，请勿手动修改
//     生成时间: 2025-11-24 12:57:32
// </auto-generated>

using System.Threading;
using System.Threading.Tasks;
using System.Collections.Generic;
using System.Linq;
using Microsoft.Extensions.Logging;
using Orleans;
using Orleans.Runtime;
using System;
using SqlSugar;
using FakeMicro.DatabaseAccess;
using FakeMicro.Interfaces;
using FakeMicro.Interfaces.Models;
using FakeMicro.Interfaces.Models.Results;
using FakeMicro.Utilities.CodeGenerator;
using FakeMicro.DatabaseAccess.Interfaces;
using AutoMapper;
using System.Linq.Expressions;

namespace FakeMicro.Entities.Grains
{
    /// <summary>
    /// EmailGrain实现
    /// </summary>
    public class EmailGrain :Grain,IEmailGrain
    {
        private readonly ILogger<EmailGrain> _logger;
        private readonly IMapper _mapper;
        private readonly IEmailRepository _repository;

        public EmailGrain(
            ILogger<EmailGrain> logger,
            IMapper mapper,
            IEmailRepository repository) // 通过接口注入
        {
            _logger = logger;
            _mapper = mapper;
            _repository = repository; // 使用注入的仓储
        }

        /// <summary>
        /// 获取Email
        /// </summary>
        public async Task<EmailDto?> GetAsync(CancellationToken cancellationToken = default)
        {
            try
            {
                long grainId;
                var idString = this.GetPrimaryKeyString();
                if (string.IsNullOrEmpty(idString) || !long.TryParse(idString, out grainId))
                {
                    _logger.LogWarning("无效的Grain ID: {GrainId}", idString);
                    return null;
                }

                var entity = await _repository.GetByIdAsync(grainId, cancellationToken);
                if (entity == null)
                {
                    _logger.LogInformation("Email不存在: {Id}", grainId);
                    return null;
                }
                return _mapper.Map<EmailDto>(entity);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取Email时发生错误: {Id}", this.GetPrimaryKeyString());
                throw; // 对于查询操作，抛出异常更合适
            }
        }

        /// <summary>
        /// 创建Email
        /// </summary>
        public async Task<CreateEmailResult> CreateAsync(CreateEmailRequest request, CancellationToken cancellationToken = default)
        {
            try
            {
                long grainId;
                var idString = this.GetPrimaryKeyString();
                if (string.IsNullOrEmpty(idString) || !long.TryParse(idString, out grainId))
                {
                    _logger.LogWarning("无效的Grain ID: {GrainId}", idString);
                    return CreateEmailResult.Failed("无效的Grain ID", "INVALID_GRAIN_ID");
                }

                var entity = _mapper.Map<Email>(request);

                // 设置默认值
                entity.Id = grainId;
                entity.CreatedAt = DateTime.UtcNow;
                entity.UpdatedAt = DateTime.UtcNow;

                await _repository.AddAsync(entity, cancellationToken);
                var result = _mapper.Map<EmailDto>(entity);

                _logger.LogInformation("Email创建成功: {Id}", entity.Id);
                return CreateEmailResult.CreateSuccess(result,entity.Id);
            }
            catch (SqlSugarException ex) 
{
               var msg = ex.InnerException?.Message ?? ex.Message; 
              if(msg.Contains("FK_"))
{ 
                _logger.LogError(ex, "创建Email创建FakeStudent时发生外键约束错误");
               return CreateEmailResult.Failed("引用的数据不存在");
}
             _logger.LogWarning(ex, "Email时发生唯一键冲突或数据库错误");
              return CreateEmailResult.Failed("Email已存在", "CONFLICT");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "创建Email时发生系统错误");
                return CreateEmailResult.Failed("创建失败，请稍后重试");
            }
        }

        /// <summary>
        /// 更新Email
        /// </summary>
        public async Task<UpdateEmailResult> UpdateAsync(UpdateEmailRequest request, CancellationToken cancellationToken = default)
        {
            try
            {
                long grainId;
                var idString = this.GetPrimaryKeyString();
                if (string.IsNullOrEmpty(idString) || !long.TryParse(idString, out grainId))
                {
                    _logger.LogWarning("无效的Grain ID: {GrainId}", idString);
                    return UpdateEmailResult.Failed("更新失败，请稍后重试", "INTERNAL_ERROR");
                }

                var existingEntity = await _repository.GetByIdAsync(grainId, cancellationToken);
                if (existingEntity == null)
                {
                    _logger.LogWarning("Email不存在: {Id}", grainId);
                    return UpdateEmailResult.Failed("Email不存在", "NOT_FOUND");
                }

                // 更新字段
                _mapper.Map(request, existingEntity);
                existingEntity.UpdatedAt = DateTime.UtcNow;

                await _repository.UpdateAsync(existingEntity, cancellationToken);
                var result = _mapper.Map<EmailDto>(existingEntity);

                _logger.LogInformation("Email更新成功: {Id}", existingEntity.Id);
                return UpdateEmailResult.CreateSuccess(result,existingEntity.Id);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "更新Email时发生系统错误: {Id}", this.GetPrimaryKeyString());
                return UpdateEmailResult.Failed("更新失败，请稍后重试");
            }
        }

        /// <summary>
        /// 删除Email
        /// </summary>
        public async Task<DeleteEmailResult> DeleteAsync(CancellationToken cancellationToken = default)
        {
            try
            {
                long grainId;
                var idString = this.GetPrimaryKeyString();
                if (string.IsNullOrEmpty(idString) || !long.TryParse(idString, out grainId))
                {
                    _logger.LogWarning("无效的Grain ID: {GrainId}", idString);
                    return DeleteEmailResult.Failed("无效的Grain ID", "INVALID_GRAIN_ID");
                }

                var existingEntity = await _repository.GetByIdAsync(grainId, cancellationToken);
                if (existingEntity == null)
                {
                    _logger.LogWarning("Email不存在: {Id}", grainId);
                    return DeleteEmailResult.Failed("Email不存在", "NOT_FOUND");
                }

                await _repository.DeleteAsync(existingEntity, cancellationToken); // 使用实体对象删除，避免类型错误

                _logger.LogInformation("Email删除成功: {Id}", grainId);
                return DeleteEmailResult.CreateSuccess();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "删除Email时发生系统错误: {Id}", this.GetPrimaryKeyString());
                return DeleteEmailResult.Failed("删除失败，请稍后重试", "INTERNAL_ERROR");
            }
        }

        /// <summary>
        /// 获取Email列表
        /// </summary>
        public async Task<List<EmailDto>> GetListAsync(int page = 1, int pageSize = 20, CancellationToken cancellationToken = default)
        {
            try
            {
                var pagedResult = await _repository.GetPagedAsync(page, pageSize, x => x.CreatedAt, true, cancellationToken);
                return _mapper.Map<List<EmailDto>>(pagedResult.Data);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取Email列表时发生系统错误");
                throw new InvalidOperationException("获取Email列表失败，请稍后重试");
            }
        }

        /// <summary>
        /// 获取Email总数
        /// </summary>
        public async Task<int> GetCountAsync(CancellationToken cancellationToken = default)
        {
            try
            {
               return await  _repository.CountAsync(null, cancellationToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取Email总数时发生系统错误");
                throw new InvalidOperationException($"获取Email总数失败，请稍后重试");
            }
        }

        /// <summary>
        /// 搜索Email
        /// </summary>
        public async Task<List<EmailDto>> SearchAsync(string keyword, int page = 1, int pageSize = 20, CancellationToken cancellationToken = default)
        {
            try
            {
                Expression<Func<Email, bool>>? predicate = null;
                // 搜索逻辑 - 根据字符串属性搜索
                if (!string.IsNullOrEmpty(keyword))
                {
                    Expression<Func<Email, bool>>? searchPredicate = null;
                      Expression<Func<Email, bool>>? propPredicate = null;
                    propPredicate = x => x.title.Contains(keyword);
                    searchPredicate = searchPredicate == null ? propPredicate : Expression.Lambda<Func<Email, bool>>(
                        Expression.OrElse(searchPredicate.Body, Expression.Invoke(propPredicate, searchPredicate.Parameters.Single())),
                        searchPredicate.Parameters.Single());
                    propPredicate = x => x.sendTo.Contains(keyword);
                    searchPredicate = searchPredicate == null ? propPredicate : Expression.Lambda<Func<Email, bool>>(
                        Expression.OrElse(searchPredicate.Body, Expression.Invoke(propPredicate, searchPredicate.Parameters.Single())),
                        searchPredicate.Parameters.Single());
                    propPredicate = x => x.Major.Contains(keyword);
                    searchPredicate = searchPredicate == null ? propPredicate : Expression.Lambda<Func<Email, bool>>(
                        Expression.OrElse(searchPredicate.Body, Expression.Invoke(propPredicate, searchPredicate.Parameters.Single())),
                        searchPredicate.Parameters.Single());
                    propPredicate = x => x.Description.Contains(keyword);
                    searchPredicate = searchPredicate == null ? propPredicate : Expression.Lambda<Func<Email, bool>>(
                        Expression.OrElse(searchPredicate.Body, Expression.Invoke(propPredicate, searchPredicate.Parameters.Single())),
                        searchPredicate.Parameters.Single());
                    
                    if (predicate == null)
                    {
                        predicate = searchPredicate;
                    }
                    else
                    {
                        predicate = Expression.Lambda<Func<Email, bool>>(
                            Expression.AndAlso(predicate.Body, Expression.Invoke(searchPredicate, predicate.Parameters.Single())),
                            predicate.Parameters.Single());
                    }
                }
                var pagedResult = await _repository.GetPagedByConditionAsync(
                    predicate ?? (x => true),
                    page,
                    pageSize,
                    x => x.CreatedAt,
                    true, // 降序
                    cancellationToken);
                var entities = pagedResult.Data;
                return _mapper.Map<List<EmailDto>>(entities);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "搜索Email时发生系统错误");
                throw new InvalidOperationException($"搜索Email失败，请稍后重试");
            }
        }

        /// <summary>
        /// 批量删除Email
        /// </summary>
        public async Task<BatchDeleteEmailResult> BatchDeleteAsync(List<long> ids, CancellationToken cancellationToken = default)
        {
            try
            {
                if (ids == null || !ids.Any())
                {
                    return BatchDeleteEmailResult.Failed(new List<string>{"批量删除ID列表不能为空"});
                }

                // 使用仓储的条件查询获取要删除的实体
                Expression<Func<Email, bool>> predicate = x => ids.Contains(x.Id);
                var pagedResult = await _repository.GetPagedByConditionAsync(
                    predicate,
                    1,
                    ids.Count, // 获取所有匹配的实体
                    x => x.Id,
                    false,
                    cancellationToken);
    var entities = pagedResult.Data;
                if (!entities.Any())
                {
                    return BatchDeleteEmailResult.Failed(new List<string>{"未找到要删除的EmailNOT_FOUND"});
                }

                await _repository.DeleteRangeAsync(entities, cancellationToken); // 使用获取到的实体列表进行删除，避免类型错误

                _logger.LogInformation("批量删除Email成功，删除数量: {Count}", entities.Count);
                return BatchDeleteEmailResult.CreateSuccess(entities.Count,entities.Count);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "批量删除Email时发生系统错误");
                return BatchDeleteEmailResult.Failed( new List<string>{"批量删除失败，请稍后重试"});
            }
        }

        /// <summary>
        /// 验证Email数据
        /// </summary>
        public async Task<ValidationResult> ValidateAsync(EmailDto data, CancellationToken cancellationToken = default)
        {
            var errors = new List<string>();

            if (string.IsNullOrWhiteSpace(data.title))
            {
                errors.Add("主题不能为空");
            }
            if (data.title?.Length > 100)
            {
                errors.Add("主题长度不能超过100个字符");
            }
            if (string.IsNullOrWhiteSpace(data.sendTo))
            {
                errors.Add("发送给谁不能为空");
            }
            if (data.sendTo?.Length > 20)
            {
                errors.Add("发送给谁长度不能超过20个字符");
            }
            if (string.IsNullOrWhiteSpace(data.Major))
            {
                errors.Add("专业不能为空");
            }
            if (data.Major?.Length > 100)
            {
                errors.Add("专业长度不能超过100个字符");
            }
            if (data.Description?.Length > 500)
            {
                errors.Add("描述长度不能超过500个字符");
            }

            if (errors.Any())
            {
                return ValidationResult.CreateFailed(errors);
            }

            return ValidationResult.CreateSuccess();
        }
    }
}
